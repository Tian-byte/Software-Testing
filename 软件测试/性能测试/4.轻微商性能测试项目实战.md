# 轻商城项目（前后端分离）

- 属性项目
- 性能测试需求分析
- 性能测试计划
- 性能测试用例编写
- 性能测试脚本编写
- 性能测试环境准备



项目背景：

​		轻商城项目是一个现在流行的电商项目。我们需要综合评估该项目中各个接口的性能，并给出优化意见和建议，以满足项目上线后的性能需求

项目功能架构

​	前台商城：购物车  订单  支付  优惠卷等

​	后台管理系统： 商品管理  会员管理  商城管理  推广管理等、

项目架构：

​	前端 vue技术开发框架  支持微信小程序，手机移动端，web界面

​	后端： springboot框架开发  mysql数据库、

​	无论是前端代码，还是后端代码，都是存放在服务器上



前后端分离和不分离两种项目的对比：

- 前后端分离的形式，数据传输的效率高很多（json数据格式 小于 html)
- 前后端分离的形式，服务器不需要处理html页面逻辑，由浏览器自己完成，减轻服务器的压力
- 在实际项目中，主要是使用前后端分离的形式



### 数据库设计

作用：

- 熟悉数据库设计结构，便于后期对数据的性能监控，方便问题定位

- 构造性能测试数据

  ![image-20240913234850864](E:\Software-Testing\软件测试\接口测试\img\image-20240913234850864.png)

项目环境搭建过程

- 获取项目源代码
  - 包括前端代码和后端代码
  - 实际工作当中项目源代码由开发提供，项目所需的配置文件，启动项目的顺序也由开发提供文档介绍
- 构建项目商城后端代码
  - 编译，打包
  - 打包成jar包或war包
- 构建前端代码
  - 使用node.js打包
  - 部署包中包含HTML  css js 等文件
- 初始化MySQL数据库
  - 项目启动前需要初始化的sql文件
  - 执行初始化数据的sql文件
  - source /user/local/litemall-db/litemall.sql
- 启动轻商后台管理系统的后端服务
  - java -jar litemall-all.jar
- 部署商城前端服务
  - 可以使用Nginx服务器
- 通过浏览器访问启动的前端，测试项目是否能正常运行





# 性能测试需求分析

- 获取需求
  - 客户方给出（传统行业）
  - 根据运营数据来计算（互联网行业）
  - 竞品分析 对比同类软件的性能指标结果
- 提取性能测试点
  - 业务维度提取
    - 用户频繁使用的业务场景 （选择商品，加购物车，下订单，商品详情）
    - 非常关键的业务功能      购物车，下订单
    - 特殊交易日或峰值交易的业务功能    秒杀活动（下订单）
    - 核心业务发生重大调整的业务功能  
  - 技术维度提取
    - 资源占用非常高的业务功能
- 确定性能测试目标
  - 轻商城作为一个新开发的项目，性能测试目标包括：
    - 确定核心业务功能的TPS(单个接口进行tps测试)
    - 对业务流程（多接口组合）运行压测
    - 系统能在实际系统运行压力的情况下，稳定的运行24小时



![image-20240914212358610](E:\Software-Testing\软件测试\接口测试\img\image-20240914212358610.png)

需求分析

- 确定测试点/功能

  - 业务角度（用的多的，重要的，核心的）
  - 技术角度（问开发技术复杂度高的）

- 确定测试目标

  - 确定核心业务功能的TPS(单个接口进行tps测试)

  - 对业务流程（多接口组合）运行压测

  - 系统能在实际系统运行压力的情况下，稳定的运行24小时





# 性能测试计划及方案

- 测试背景
- **测试目的**
- **测试范围**
- **测试策略**
  - 基准测试：先做基准测试，确定估计的标准
  - 负载测试：分别模拟 5  10 30 50 100 个用户对系统进行负载测试，查看不同并发时系统软件各项指标是否否和需求
  - 稳定性测试： 用200 用户对系统进行7*24 小时的不间断稳定性测试
- 风险控制
- 交付清单
- **进度与分工**





# 性能测试用例设计

![image-20240914215432579](E:\Software-Testing\软件测试\接口测试\img\image-20240914215432579.png)

性能测试用例编写：

根据测试点逐条进行细化

- 性能的测试数据，有明确需求，需要达到一定的业务量

- 从接口的维度来描述测试步骤
- 如果两个接口强绑定（结算，下订单），方在一个用例中间测试





# 性能测试执行

- 编写测试脚本
- 建立测试环境
- 性能测试监控
- 执行测试脚本



![image-20240914223208587](E:\Software-Testing\软件测试\接口测试\img\image-20240914223208587.png)

单接口测试脚本：

![image-20240914230231788](E:\Software-Testing\软件测试\接口测试\img\image-20240914230231788.png)



在HTTP请求下添加断言：

- 如果做接口测试，必须添加断言响应信息  可以添加状态码和描述信息
- 如果做性能测 可以只添加状态码和描信息

添加购物车脚本：

- 添加登录请求
- 添加json 提取器，提取token
- 将token 设置为http信息头管理器中
- 添加购物车
- 添加断言：如果时接口测试需要在查询我的购物车，检查我的购物车是否与加入购物车返回的数据是否一致



# 搭建性能测试环境

性能测试环境的特点：

- 独占性
- 尽量与生产环境保持一致
  - 硬件环境
    - 包括服务器环境，网络环境等
  - 软件环境
    - 版本一致：包括操作系统，数据库，被测试应用程序，第三方软件等
    - 配置一致： 包括操作系统，数据库，被测试应用程序，第三方软件等
  - 使用场景的一致
    - 基础业务数据的一致
    - 业务操作模式的一致性：尽量模拟真实情境下用户的使用情况



如何构造测试数据

目的：压测环境中的数据量尽量与生产环境中的数据量一致

方法：为了快速创造大量的数据，可以直接操作数据库进行添加

- 准备插入数据库的sql语句
- 循环执行次数来插入数据
  - 导包
  - 连接数据库
  - 创建游标
  - 执行sql语句
  - 关闭游标
  - 关闭连接

 # 执行测试脚本

### 性能测试脚本执行

- 准备数据
- 修改脚本
- 监控性能指标
- 模拟并发
- 结果分析



### 登录脚本- 监控性能指标

- 准备数据
- 修改脚本

使用random函数 来保证每次登录时，使用不同的用户名登录

- 监控性能指标
  - 系统指标：  响应时间，吞吐量 错误率  并发数
    - （聚合报告）
  - 资源指标  cpu 内存 磁盘  网络
    - PerForm组件
- 模拟并发
- 结果分析





# 稳定性测试：

- 确定出稳定性运行的所有业务（同时运行）
- 根据运营数据，分析出每个业务操作对应的虚拟用户数



稳定性测试执行：

- 所有的脚本同时执行（解除前后端依赖）
- 每个脚本都是一个事务/业务 -- 事务控制器
- 按照要求设置虚拟用户数和运行时间
- 执行稳定性测试并监控





# 性能分析和调优

- 性能调优的步骤
- 性能测试的瓶颈
- 性能调优的案例

### 性能调优的步骤

1. 确定问题：根据性能监控的数据和性能分析的结果，确定性能存在的问题（要求）
2. 确定原因：确定了问题之后，对问题进行分析，找出问题产生的原因（开发）
3. 给出解决方案：确定调整目标和解决方案（该服务器参数配置/增加硬件资源配置/修改代码）
4. 验证问题：按照给出的解决方案，重新进行测试（回归测试）
5. 分析调优结果：分析出问题的性能指标是否有提升，并关注其他指标为下降

### 性能瓶颈分析

在实际的性能测试中，会遇到各种各样的问题，比如TPS压不上去，导致这种现象的原因很多，测试人员应该配合开发分析尽快找出问题的瓶颈

常见的性能瓶颈分析：

- 服务器资源分析
  - cpu瓶颈   单位是时间
  - 内存瓶颈
  - 磁盘I/O瓶颈
  - 网络宽带
- JVM瓶颈分析
  - JVM内存
- 数据库瓶颈分析
  - 慢查询
  - 数据库的连接池
  - 数据库锁死
- 程序内部实现机制分析
- 压测机  
  - JMeter 单击负载能力有限，如果需要模拟的用户请求数超过负载极限，也会导致TPS压不上去

### 内存和虚拟内存

内存：有称为主存储器/物理存储器，计算机中所有的程序的运行都在内存中进行

虚拟内存： 是计算机系统内存管理的一种技术。当计算机内存不足时，可以使用虚拟内存进行补偿

注意：

- 由于虚拟内存，实际上完成的数据在磁盘和内存之间的读写过程，磁盘的速度要远慢于内存时，因此使用虚拟内存时，说明内存已经不足，可能存在问题
- 命令
  - 查看总量 top
  - 查看虚拟内存的使用 vmstat
- 测试关注点
  - 实际内存 查看内存使用百分比 检查是否超过 80%
  - 虚拟内存： 查看swap 的si 和 so 是否为0  如果不为0 说明内存可能不足需要交换



### 磁盘I/O 瓶颈

磁盘IO瓶颈：影响性能的时磁盘的读写速度（input / output 速度） 不时磁盘大小

查看磁盘命令： iostat -x  l l

- %util 表示一秒钟有多个百分之多少的用时于 i/o
- % iowait: CPU 等待输入输出完成时间的百分比 

测试关注点：

- %util 高 说明磁盘长时间占用cpu在发送数据,说明磁盘的传输速度不足，存在瓶颈
- %iowait 高，说明磁盘传输的任务很多，在等待，说明磁盘的传输速度不足，存在瓶颈

### 网络瓶颈

网络瓶颈：影响性能的是网络的传输速度，与网络的总宽度进行对比，接近带宽，说明网络存在瓶颈

查询带宽的命令：

- sar -n DEV 1 2

测试关注点：

- 实际统计的发送速率和接受速率，与网络的总带宽进行对比，查看使用的百分比（如果无线接近于百分之百 说明存在网络性能瓶颈）

补充介绍

- 带宽： B/s  1B = 8b 数据在网络中传输的速率
  - 实际1000M宽带 --- 对应带宽的速度为 1000/8 
- 宽带：用户或者业务角度来描述网络速率的方式 bit/s



### 数据库分析瓶颈  ---- 慢查询

慢查询定义：指执行速度低于设置的阀值的sql语句

作用：帮助定位查询速度较慢的sql语句，方便更好的优化数据库的性能



MySQL慢查询介绍：

查询语句  show variables like 'slo_query%'

- slow_query_log  慢查询日志开启状态【on  开启  off 关闭】
- slow_query_log_file  慢查询日志存放位置
- long_query_time 慢查询时间设置（超过该时长才会被记录，单位：秒）



慢查询开启匹配：（命令）

- set global slow_query_log='ON' #开启慢查询日志
- set  global show_query_log_file='data/slow_query.log'   # 设置慢查询日志存放位置
- set  global long_query_time=1    # 设置慢查询时间标准，设置之后会在下次会话才生效  

数据库监控：

1. 慢查询   找出查询速度慢的sql语句
   - 慢：查询时间超过设置的阈值
   - 慢查询的参数(三个)
   - 慢查询相关参数：show variables like ""
2. 设置慢查询的参数：set gloabl 参数名 = 值
3. 设置完并运行脚本
4. 测试关注点
   - 基于当前记录下来的慢查询sql进行分析进一步的分析，判断是否存在问题，需要修改

### 数据库瓶颈 --- 数据库连接池

数据库连接池： 数据库连接池是负责分配，管理和释放 数据库连接，他允许应用程序重复使用一个现有的数据库连接，而不是重新建立一个

作用：可以提高对数据库操作的性能



当客户请求数据库连接时：

- 首先查看连接池中是否有空闲连接，如果存在空闲连接，则分配给客户使用
- 如果没有空闲连接，则查看当前所断开的连接数是否以已达到最大连接数，如果没达到就重新创建一个连接池给请求的客户
- 如果达到就按设定的最大等待时间进行等待
- 如果超出了最大等待时间，则抛出给用户



测试关注点：

- mysql 官网给出了一个设置最大连接数的比例：Max_used_connections/max_connects * 100% = 85% 需要关注mysql 的最大连接数和系统运行时数据库已建立连接数的比例
- 如果已使用连接数与最大连接数的比例超过百分之八十五，需要增加连接数设置，否则会造成连接失败
- 如果已使用连接数与最小连接数比例小于10% 那显然设置的过大，会造成系统资源的浪费

 

### MySQL锁

当一个用户修改数据时，对该数据进行加锁操作，其他用户不能进行修改

只有当一个用户修改完成后，其他用户才能修改

MySQL主要有两种锁： 表级，行级

- 表级锁：开销小，加锁块；不会出现锁死；锁定力度最大，并发度最低
- 行级锁： 开销大，加锁慢；会出现锁死；锁定力度最小，并发度最高



### java 应用瓶颈分析  -- jvm内存



- java内存：java 虚拟机在执行java 程序的过程中所管理的不同内存数据，简单可分为：堆内存 和非堆内存

- 非堆内存  保证虚拟机自己的静态数据，存放加载的Class 类级别对象如 类 ，方法 等  给jvm自己使用

- 堆内存：主要存放 new关键字创建的对象，所有的对象实例以及数组都放在堆上

  jvm堆内的管理机制（垃圾回收机制）

  - 年轻代存储"新生对象"，我们创建的对象在青年代中
  - 当年轻内存占满后，会触发Minor Gc ，清理年轻代内存空间
  - 老年存储长期存活的对象和大对象。。年轻代中存储的对象，经过多次GC后依然存活的对象会移动到老年代中进行存储
  - 老年代空间占满后，会触发Full GC。Full GC 是清理整个堆空间，包括年轻代和老年代

常见内存问题：

- 内存泄露
  - 内存泄露 momory leak 是指挥程序在申请内存后，无法完全释放自己申请的内存空间
  - 一次内存泄露危害可以忽略，但内存泄露堆积后果很验证，无论多少内存，迟早被占光
- 内存溢出
- 内存溢出 out of memory 是指程序在申请内存时，没有足够的内存空间使其使用，出现out of memory
- memory  leak 会最终导致 out of memoky  

### JVM监控  ————— jvisyalvm.exe

- 在java 程序启动时，添加启动参数
- 进入jdk 的bin  目录下，选择 jvisualvm.exe
- 点击远程，右键选择“添加远程主机”，并配置服务器ip





### 压测机瓶颈分析  -  压测机

- 压测机 影响性能测试的原因主要是：
  - JMeter 单击负载能力有限，如果需要模拟的用户请求数据超过负载极限，也会导致TPS压不上去
- 压测机资源的监控方法
  - Windows 测试机：“任务管理器”
  - linux 压测机： "PerfMon 组件" 或者 top命令
- 解决方案
  - 采用分布式执行的方法来提高负载量，达到系统性能测试要求的TPS





### 常见的性能

- 服务器资源分析
  - cup瓶颈 用户cpu和系统CPU
  - 内存瓶颈：实际内存和虚拟内存
  - 磁盘io瓶颈： 磁盘input 和 output
  - 网络瓶颈: 网络上下行带宽
- 数据库瓶颈分析
  - 慢查询
  - 数据库连接池
  - 死锁
- jvm 瓶颈分析
  - jvm内存：堆内存和内存回收
- 程序内部实现机制
- 压测机



### 案例 获取首页数据

问题

1. cpu 已近解接近100% 
2. 一次请求需要查询很多数据



解决方案：

- 提升服务器配置
- 分批次，异步加载数据，首页底部的数据（如：新品发布，热卖商品，专题精选等数据）等用户向下滑动页面在加载



案例2： --- 查询商品详情  （网络）

场景描述：

- 进入商品详情页面时，加载商品的详情

原因： 

- 已使用的网络宽带已接近于总带宽

解决方案

- 增加网络
- 减少进入商品详情页面的数据请求量

案例3 --- 搜索商品

- 场景描述
  - 进入首页，在搜索框中输入关键字搜索商品
- 测试结果数据
  - 搜索关键字 “床”  出现慢查询 sql 语句
  - 查看慢查询语句cat /var/lib/mysql/localhost-slow.log
- 解决方案
  - 找出搜索商品接口对应的sql语句（通过日志查看代码实现或者从日志中获取查询sql) 



### JVM内存溢出

解决方法：

- 开发定位出泄露的点，修改代码





# 性能测试报告的总结

- 测试过程回顾  - 测试目的  测试范围 测试环境  测试工具  
- 测试问题记录及结果分析   ---- bug 性能测试过程中遇到的问题和解决的方案
- 测试结论    
- 测试经验和教训

 



